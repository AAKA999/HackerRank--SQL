--MS SQL SERVER
SELECT A.ID, A.AGE, A.COINS_NEEDED, A.POWER 
FROM (
SELECT W.ID, P.AGE, W.COINS_NEEDED, W.POWER, 
ROW_NUMBER() OVER (PARTITION BY P.AGE, W.POWER ORDER BY W.COINS_NEEDED) RN
FROM WANDS W
JOIN WANDS_PROPERTY P
ON W.CODE=P.CODE
WHERE P.IS_EVIL=0
) A
WHERE A.RN=1
ORDER BY A.POWER DESC, A.AGE DESC